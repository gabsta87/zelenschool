<ion-content>
<div class="adminContent">

    <h1>Manage</h1>

    <ion-button *ngIf="requestsCount|async as count" (click)="filterRequests()">
        Teachers requests 
        <ion-badge color="danger" slot="end">{{count}}</ion-badge>
    </ion-button>
    
    <ion-button class="activatedButton" *ngIf="showUsers.value; else hideUsers" (click)="toggle(showUsers)"><ion-icon name="caret-up-outline"></ion-icon>Users</ion-button>
    <ng-template #hideUsers>
        <ion-button (click)="toggle(showUsers)"><ion-icon name="caret-down-outline"></ion-icon>Users</ion-button>
    </ng-template>
    
    <ion-button class="activatedButton" *ngIf="showCourses.value; else hideCourses" (click)="toggle(showCourses)"><ion-icon name="caret-up-outline"></ion-icon>Courses</ion-button>
    <ng-template #hideCourses>
        <ion-button (click)="toggle(showCourses)"><ion-icon name="caret-down-outline"></ion-icon>Courses</ion-button>
    </ng-template>
    
    <ion-button class="activatedButton" *ngIf="showAssoMembers.value; else hideAsso" (click)="toggle(showAssoMembers)"><ion-icon name="caret-up-outline"></ion-icon>Association members</ion-button>
    <ng-template #hideAsso>
        <ion-button (click)="toggle(showAssoMembers)"><ion-icon name="caret-down-outline"></ion-icon>Association members</ion-button>
    </ng-template>
    
    <ion-button class="activatedButton" *ngIf="showPartners.value; else hidePartners" (click)="toggle(showPartners)"><ion-icon name="caret-up-outline"></ion-icon>Partners</ion-button>
    <ng-template #hidePartners>
        <ion-button (click)="toggle(showPartners)"><ion-icon name="caret-down-outline"></ion-icon>Partners</ion-button>
    </ng-template>
    
    <ion-button>
        Photos gallery
    </ion-button>
    <ion-button>
        Activities
    </ion-button>
    
    <ion-button class="activatedButton" *ngIf="showRooms.value; else hideRooms" (click)="toggle(showRooms)"><ion-icon name="caret-up-outline"></ion-icon>Rooms</ion-button>
    <ng-template #hideRooms>
        <ion-button (click)="toggle(showRooms)"><ion-icon name="caret-down-outline"></ion-icon>Rooms</ion-button>
    </ng-template>
    

    <ion-searchbar *ngIf="showUsers.value || showCourses.value" placeholder="Search" [(ngModel)]="searchString" (ionChange)="updateSearchValue()"></ion-searchbar>

    <ng-container *ngIf="filteredDataObs | async as filteredData">
    <div *ngIf="showUsers.value">
    <h1>Users</h1>
    <ion-item lines="none">
        <ion-select interface="action-sheet" [(ngModel)]="statusToFilter" (ionChange)="filterUsersList()" value="all">
            <ion-select-option value="all">All</ion-select-option>
            <ion-select-option value="student">Students</ion-select-option>
            <ion-select-option value="teacher">Teachers</ion-select-option>
            <ion-select-option value="admin">Admins</ion-select-option>
            <ion-select-option value="request">Teachers requests </ion-select-option>
            <ion-select-option value="ban">Banned</ion-select-option>
        </ion-select>
    </ion-item>

        <ion-accordion-group [multiple]="true">
            <ion-item *ngFor="let usr of filteredData[0]" lines="none">
                <ion-accordion [value]="usr['l_name']">
                    <ion-item slot="header" color="light">
                      <ion-label>{{usr['l_name']}} {{usr['f_name']}}</ion-label>
                    </ion-item>
                    <div class="ion-padding" slot="content">
                        <p>email : {{usr['email']}}</p>
                        <p>Status : {{usr['status']}}</p>
                        <p *ngIf="usr['phone']">Phone : {{usr['phone']}}</p>
                        <p *ngIf="usr['birthday']">Birthday : {{usr['birthday']}}</p>
                        <p *ngIf="usr['s_permit_id']">S permit ID : {{usr['s_permit_id']}}</p>
                        <p *ngIf="usr['address']">Address : {{usr['address']}}</p>
                        <p *ngIf="usr['subscribeDate']">Subscribe date : {{usr['subscribeDate']}}</p>
                        <ion-text *ngIf="usr['ban']" color="danger">
                        <p> Banned on : {{usr['ban'].date}} by {{usr['ban'].author?.l_name}} {{usr['ban'].author?.f_name}}<br>
                        Reason : {{usr['ban'].comment}}</p>
                        </ion-text>
                        <span>
                        <ion-button *ngIf="usr['ban'] == undefined; else unban" (click)="banUser(usr['id'])">Ban</ion-button>
                        <ng-template #unban>
                            <ion-button (click)="unbanUser(usr['id'])">Unban</ion-button>
                        </ng-template>
                        <ion-button (click)="deleteUser(usr['id'])">Delete</ion-button>
                        <ion-button *ngIf="usr['status']=='request'" (click)="acceptRequest(usr['id'])">Accept teacher</ion-button>
                        </span>
                    </div>
                </ion-accordion>
            </ion-item>
        </ion-accordion-group>
    </div>

    <div *ngIf="showCourses.value">
    <h1>Courses</h1>
    <ion-item lines="none">
        <ion-select interface="action-sheet" [(ngModel)]="timeFilter" (ionChange)="filterCoursesList()" value="all">
            <ion-select-option value="all">All</ion-select-option>
            <ion-select-option value="future">Courses to come</ion-select-option>
            <ion-select-option value="past">Past courses</ion-select-option>
        </ion-select>
    </ion-item>

    <ion-accordion-group [multiple]="true">
        <ion-item *ngFor="let course of filteredData[1]" lines="none">
            <ion-accordion [value]="course['title']">
                <ion-item slot="header" color="light">
                    <ion-label>{{course['title']}} {{course['timeStart']| date: "HH:mm d MMM, yy"}} {{course['author'].l_name}} {{course['author'].f_name}}</ion-label>
                </ion-item>
                <div class="ion-padding" slot="content" (click)="handleEvent(course)">
                    <p>Room : {{course['room_id']}}</p>
                    <p>Participants : {{course['attendantsId'].length}}/{{course['max_participants']}}</p>
                    <p *ngIf="course['description']">Description : {{course['description']}}</p>
                    <ion-list *ngIf="course['attendantsId'].length > 0" class="ion-no-padding">
                        <ion-label>Students</ion-label>
                        <ion-item *ngFor="let student of course['attendantsId']">
                            <ion-label *ngIf="student; else unknown">{{student['l_name']}} {{student['f_name']}}</ion-label>
                            <ng-template #unknown><ion-label>Unknown</ion-label></ng-template>
                        </ion-item>
                    </ion-list>
                </div>
            </ion-accordion>
        </ion-item>
    </ion-accordion-group>
    </div>
    </ng-container>

    <div *ngIf="showAssoMembers.value">
        <h1>Association members</h1>
        <div lines="none" class="addButtonContainer">
            <ion-button (click)="createMember()" color="success"> <ion-icon name="add-circle-outline"></ion-icon> Add new</ion-button>
        </div>
        <ion-accordion-group>
            <ion-item *ngFor="let usr of (assoMembers|async)" lines="none">
                <ion-accordion [value]="usr['name']">
                    <ion-item slot="header" color="light">
                    <ion-label> <b>{{usr['name']}}</b> {{usr['role']}}</ion-label>
                    </ion-item>
                    <div class="ion-padding" slot="content">
                        
                        <div *ngIf="editingMember.value; else displayMember" >
                            <ion-grid>
                                <ion-row>
                                    <ion-col size="1">
                                        <ion-label>Name</ion-label>
                                    </ion-col>
                                    <ion-col>
                                        <ion-input type="text" [(ngModel)]="memberNewName"> </ion-input>
                                    </ion-col>
                                </ion-row>
                                <ion-row>
                                    <ion-col size="1">
                                        <ion-label>Role</ion-label>
                                    </ion-col>
                                    <ion-col>
                                        <ion-input type="text" [(ngModel)]="memberNewRole"> </ion-input>
                                    </ion-col>
                                </ion-row>
                                <ion-row>
                                    <ion-col size="1">
                                        <ion-label>Link</ion-label>
                                    </ion-col>
                                    <ion-col>
                                        <ion-input type="text" [(ngModel)]="memberNewLink"> </ion-input>
                                    </ion-col>
                                </ion-row>
                            </ion-grid>
                            <ion-thumbnail style="cursor: pointer;">
                                <input type="file" (change)="onFileSelected($event)" accept="*" required style="display: none;" #fileUpload>
                                <ion-item (click)="fileUpload.click()" lines="none">
                                    <ion-img *ngIf="photoChanged.value;else dbPhoto" [src]="tempImage" alt="Profile view"></ion-img>
                                    <ng-template #dbPhoto>
                                        <ion-img [src]="usr['photo']" alt="Profile view"></ion-img>
                                    </ng-template>
                                </ion-item>
                            </ion-thumbnail>
                            
                            <span>
                                <ion-button color="danger" (click)="deleteMember(usr['id'])">Delete</ion-button>
                                <ion-button (click)="cancelMemberEdit()">Cancel</ion-button>
                                <ion-button (click)="updateMember()">Update</ion-button>
                            </span>
                        </div>

                        <ng-template #displayMember>
                            <!-- <p>Name : {{usr['name']}}</p>
                            <p>Role : {{usr['role']}}</p> -->
                            <p>Link : {{usr['link']}}</p>
                            <ion-thumbnail>
                                <ion-img [src]="usr['photo']" alt="Profile view"></ion-img>
                            </ion-thumbnail>
                            <span>
                                <ion-button color="danger" (click)="deleteMember(usr['id'])">Delete</ion-button>
                                <ion-button (click)="editMember(usr['id'])">Edit</ion-button>
                            </span>
                        </ng-template>

                    </div>
                </ion-accordion>
            </ion-item>
        </ion-accordion-group>
    </div>

    <div *ngIf="showPartners.value">
        <h1>Partners</h1>
        <div lines="none" class="addButtonContainer">
            <ion-button (click)="createPartner()" color="success"> <ion-icon name="add-circle-outline"></ion-icon> Add new</ion-button>
        </div>
        <ion-list lines="none">
            <ion-item *ngFor="let partner of partnersData; let i = index" lines="none">
                <ion-grid>
                    <ion-row>
                        <ion-col size="3">
                            <input type="file" (change)="onFileSelectedPartners($event,i)" accept="*" required style="display: none;" #fileUpload>
                            <ion-thumbnail style="cursor: pointer;">
                                <ion-item (click)="fileUpload.click()" lines="none">
                                    <ion-img *ngIf="partner.photoChanged;else dbPhotoPartner" [src]="tempImagePartner" alt="Profile view"></ion-img>
                                    <ng-template #dbPhotoPartner>
                                        <ion-img [src]="partner.logoName" alt="Profile view"></ion-img>
                                    </ng-template>
                                </ion-item>
                            </ion-thumbnail>
                        </ion-col>
                        <ion-col>
                            <ion-input type="text" [(ngModel)]="partnersData[i].link"> </ion-input>
                        </ion-col>
                    </ion-row>
                    <ion-row>
                        <span>
                            <ion-button color="danger" (click)="deletePartner(i)">Delete</ion-button>
                            <ion-button (click)="restorePartner(i)">Restore</ion-button>
                            <ion-button (click)="updatePartner(i)">Update</ion-button>
                        </span>
                    </ion-row>
                </ion-grid>
            </ion-item>
        </ion-list>
    </div>

    <div *ngIf="showRooms.value">
        <h1>Rooms</h1>
        <div lines="none" class="addButtonContainer">
            <ion-button (click)="createRoom()" color="success"> <ion-icon name="add-circle-outline"></ion-icon> Add new</ion-button>
        </div>
        <ion-list lines="none">
            <ion-item *ngFor="let room of roomsData; let i = index" lines="none">
                <ion-grid>
                    <ion-row>
                        <ion-col size="1">
                            <ion-label>Name </ion-label>
                        </ion-col>
                        <ion-col>
                            <ion-input type="text" [(ngModel)]="roomsData[i].name"> </ion-input>
                        </ion-col>
                        <ion-col size="2">
                            <ion-label>Max students </ion-label> 
                        </ion-col>
                        <ion-col>
                            <ion-input type="text" [(ngModel)]="roomsData[i].maxStudents"> </ion-input>
                        </ion-col>
                    </ion-row>
                    <ion-row>
                        <span>
                            <ion-button color="danger" (click)="deleteRoom(i)">Delete</ion-button>
                            <ion-button (click)="updateRoom(i)">Update</ion-button>
                        </span>
                    </ion-row>
                    <ion-row>
                        <ion-popover #roomUpdatePopOver [isOpen]="showRoomConfirmation" (didDismiss)="showRoomConfirmation = false">
                        <ng-template>
                            <ion-content class="ion-padding"> Value updated!</ion-content>
                        </ng-template>
                        </ion-popover>
                    </ion-row>
                </ion-grid>
            </ion-item>
        </ion-list>
    </div>

</div>
</ion-content>